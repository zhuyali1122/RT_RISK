# 底层资产组合 - 数据查询说明

Vintage 与 DPD 账龄的底层资产列表均对应数据库查询，未来接入数据库时按以下逻辑实现。

## 一、调用入口

| 入口 | 路由 | 查询参数 |
|------|------|----------|
| Vintage 放款月 | `/partner/<id>/vintage/<disbursement_month>` | partner_id, disbursement_month (如 2025-10) |
| DPD 账龄 | `/partner/<id>/dpd/<bucket>` | partner_id, bucket (M0/M1/M2/M3/M4/M5/M6+), stat_date |

## 二、统一数据格式

每条 Loan 记录需包含：

| 字段 | 说明 |
|------|------|
| loan_id | 贷款 ID |
| customer_type | 新客(new) / 老客(returning) |
| product_type | 产品类型，由 (Repayment_type, Terms) 组合生成，如 等额本息_12月、等本等息_6月 |
| credit_rating | 信用评级，来自 raw_customer.rating_a |

**产品类型**：`{Repayment_type}_{Terms}月` 组合区分不同产品。Repayment_type 来自 raw_loan.repayment_method（1=等额本息，2=等本等息），Terms 来自 raw_loan.term_months。  
**信用评级**：从 raw_customer 表按 customer_id 关联取 rating_a 列。
| disbursement_amount | 放款金额 |
| disbursement_time | 放款时间 |
| term_month | 期限(月) |
| custom_rate | 利率 |
| penalty_rate | 罚息率 |
| loan_status | 状态 |
| dpd | 逾期天数 |
| outstanding_principal | 未偿本金 |
| overdue_principal | 逾期本金 |
| overdue_interest | 逾期利息 |
| overdue_penalty | 逾期罚息 |

## 三、查询逻辑（伪 SQL）

**Vintage 按放款月：**
```sql
SELECT * FROM loans
WHERE partner_id = ? AND disbursement_month = ?
ORDER BY loan_id;
```

**DPD 按账龄：**
```sql
-- M0: dpd = 0
-- M1: dpd 1-30
-- M2: dpd 31-60
-- M3: dpd 61-90
-- M4: dpd 91-120
-- M5: dpd 121-150
-- M6+: dpd >= 151
SELECT * FROM loans
WHERE partner_id = ? AND stat_date = ?
  AND (CASE WHEN ? = 'M0' THEN dpd = 0
            WHEN ? = 'M1' THEN dpd BETWEEN 1 AND 30
            ... END)
ORDER BY loan_id;
```

## 四、页面展示

- **饼图**：新客/老客占比、产品分布（概览）
- **筛选**：按新客/老客、产品类型筛选列表
- **列表**：统一格式资产列表

---

## 五、单个 Loan 详情

点击 Loan ID 进入详情页，包含：

### 1. 客户基础信息
| 字段 | 说明 |
|------|------|
| industry | 行业 |
| credit_rating | 信用评级 |
| region | 地区 |
| education | 教育程度 |

### 2. 还款计划 (schedule)
| 字段 | 说明 |
|------|------|
| period | 期次 |
| due_date | 还款日期 |
| principal_due | 应还本金 |
| interest_due | 应还利息 |
| total_due | 应还总额 |
| status | 状态 (paid/pending) |

### 3. 还款信息 (repayments)
| 字段 | 说明 |
|------|------|
| payment_date | 还款日期 |
| period | 对应期次 |
| amount | 还款金额 |
| principal_paid | 还款本金 |
| interest_paid | 还款利息 |
| penalty_paid | 还款罚息 |
| waive_amount | Waive 金额 |
