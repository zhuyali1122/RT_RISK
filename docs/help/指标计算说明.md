# CHUAN 指标计算说明

本文档说明资产商管理平台中各生产商页面的指标计算方式。**当任何指标算法发生变化时，请同步更新本文档。**

---

## 一、风控监控页面

数据来源：`calc_overdue` 表、`raw_loan`、`raw_repayment`。统计口径：仅包含 `loan_status IN (1, 2)` 的未结清贷款（1=正常，2=逾期，3=结清）。

### 1.1 核心指标

| 指标 | 计算公式 | 说明 |
|------|----------|------|
| **在贷余额 (current_balance)** | `SUM(outstanding_principal)` | 所有未结清贷款的未偿本金之和 |
| **累计放款 (cumulative_disbursement)** | `SUM(disbursement_amount)` | `raw_loan` 中 `disbursement_time <= stat_date` 的放款金额之和 |
| **M0 余额 (m0_balance)** | `SUM(CASE WHEN dpd = 0 THEN outstanding_principal ELSE 0 END)` | DPD=0（正常）贷款的未偿本金之和 |
| **M0 占比 (m0_ratio)** | `m0_balance / current_balance` | 正常贷款余额占在贷余额的比例，目标 ≥ 96% |
| **M0 应收利息 (m0_accrued_interest)** | 还款计划中 `due_date <= stat_date` 的应还利息 - 已还利息 | 对每笔 M0 贷款：从 `repayment_schedule` 取应还未还利息；若 `calc_overdue` 有 `accrued_interest` 列则直接汇总 |
| **活跃贷款数 (active_loans)** | `COUNT(*)` | 未结清贷款笔数 |
| **活跃借款人数 (active_borrowers)** | `COUNT(DISTINCT customer_id)` | 去重后的借款人数 |
| **平均期限 (avg_duration)** | `AVG(term_months)` | 贷款平均期限（月） |
| **平均日利率 (avg_daily_rate)** | `AVG(customer_rate)` | 客户利率平均值 |
| **放款加权利率 (disbursement_weighted_rate)** | `SUM(rate * disbursement) / SUM(disbursement)` | 按放款金额加权的客户利率 |

### 1.2 逾期率指标

| 指标 | 计算公式 | 说明 |
|------|----------|------|
| **OD1+ 逾期率 (overdue_1_plus_ratio)** | `逾期笔数(DPD≥1) / active_loans` | 逾期 1 天及以上贷款笔数占比 |
| **OD3+ 逾期率 (overdue_3_plus_ratio)** | `逾期笔数(DPD≥3) / active_loans` | 逾期 3 天及以上贷款笔数占比 |
| **OD7+ 逾期率 (overdue_7_plus_ratio)** | `逾期笔数(DPD≥7) / active_loans` | 逾期 7 天及以上贷款笔数占比 |
| **OD15+ 逾期率 (overdue_15_plus_ratio)** | `逾期笔数(DPD≥15) / active_loans` | 逾期 15 天及以上贷款笔数占比 |
| **OD30+ 逾期率 (overdue_30_plus_ratio)** | `逾期笔数(DPD≥30) / active_loans` | 逾期 30 天及以上贷款笔数占比 |

### 1.3 DPD 分布

按 DPD（Days Past Due）将贷款分为以下账龄档位：

| 档位 | DPD 范围 | 说明 |
|------|----------|------|
| M0 | 0 | 正常 |
| M1 | 1–30 | 逾期 1–30 天 |
| M2 | 31–60 | 逾期 31–60 天 |
| M3 | 61–90 | 逾期 61–90 天 |
| M4 | 91–120 | 逾期 91–120 天 |
| M5 | 121–150 | 逾期 121–150 天 |
| M6+ | ≥151 | 逾期 151 天及以上 |

每档的 **balance** 为该档内所有贷款的 `outstanding_principal` 之和；**balance_ratio** = 该档 balance / 总在贷余额。

### 1.4 Vintage 账龄分析

按放款月份（cohort）分组，计算各 cohort 的逾期表现：

| 指标 | 计算公式 | 说明 |
|------|----------|------|
| **disbursement_amount** | `SUM(disbursement_amount)` | 该月放款总额 |
| **current_balance** | `SUM(outstanding_principal)` | 该月放款贷款在 stat_date 的未偿本金 |
| **dpd1_rate** | `overdue_1_bal / current_balance` | DPD≥1 余额占比 |
| **dpd3_rate** | `overdue_3_bal / current_balance` | DPD≥3 余额占比 |
| **dpd7_rate** | `overdue_7_bal / current_balance` | DPD≥7 余额占比 |
| **dpd15_rate** | `overdue_15_bal / current_balance` | DPD≥15 余额占比 |
| **dpd30_rate** | `overdue_30_bal / current_balance` | DPD≥30 余额占比 |
| **MOB** | `(stat_date 所在月 - disbursement_month)` 的完整月数 | 账龄（Month on Book） |
| **mob{N}_rate** | 当前 MOB 时用 dpd1_rate 近似 | 该 MOB 的逾期率 |

### 1.5 回收报表 (Collection Report)

按到期月（maturity_month）汇总：

| 指标 | 说明 |
|------|------|
| **due_amount** | 该到期月所有贷款的应还总额（本金+利息，来自 repayment_schedule） |
| **d0_into_collection** | 到期当月 DPD=0 的未偿本金 |
| **d1_into_collection** | DPD 1–3 的未偿本金 |
| **d3_into_collection** | DPD 4–7 的未偿本金 |
| **d7_into_collection** | DPD 8–30 的未偿本金 |
| **d30_into_collection** | DPD 31–60 的未偿本金 |
| **d60_into_collection** | DPD 61–90 的未偿本金 |
| **d90_into_collection** | DPD 91+ 的未偿本金 |
| **d1_recovery, d3_recovery, ...** | 各回收档位的实际回收金额（来自 raw_repayment） |

### 1.6 优先级指标（来自 spv_initial_params）

| 指标 | 计算公式 | 说明 |
|------|----------|------|
| **覆盖倍数 (coverage_ratio)** | `V / L` | **Value** = (M0本金 + M0应收利息 × 早偿逾期折损) × (1 - Vtg30预估违约率) + 现金；**Loan** = 合作本金 + 未分配收益（spv_initial_params 中已是 USD） |
| **杠杆倍数 (leverage_ratio)** | 从 spv_config 或 spv_initial_params 读取 | Senior:Junior 比例 |
| **优先收益率 (priority_yield)** | 从 spv_initial_params 表 agreed_rate 读取 | 目标收益率 |
| **保证金 (margin_deposit)** | 从 spv_initial_params 读取 | 当前 vs 要求 |
| **担保金 (guarantee_deposit)** | 从 spv_initial_params 读取 | 当前 vs 要求 |

---

## 二、收益规模页面

数据来源：`raw_loan`、`raw_repayment`、`calc_overdue`。按月汇总。

### 2.1 核心指标

| 指标 | 计算公式 | 说明 |
|------|----------|------|
| **当月放款 (disbursement)** | `SUM(disbursement_amount)` | `raw_loan` 中 `disbursement_time` 当月放款金额 |
| **累计放款 (cumulative_disbursement)** | `SUM(disbursement_amount)` | 截至当月末的累计放款 |
| **在贷余额 (outstanding_balance)** | `SUM(outstanding_principal)` | 当月末 `calc_overdue` 中 loan_status 1/2 的未偿本金 |
| **当月回收 (collection)** | 本金 + 利息 + 罚息/展期费 | `raw_repayment` 当月 `principal_repayment` + `interest_repayment` + `penalty_repayment` + `extension_fee` |
| **利息收入 (interest_income)** | `SUM(interest_repayment)` | 当月利息回收 |
| **手续费 (fee_income)** | `SUM(penalty_repayment + extension_fee)` | 罚息与展期费 |
| **净收益 (net_revenue)** | `interest_income + fee_income` | 投资者视角的净收益 |

### 2.2 年化收益率

**公式**：`年化收益率 = 单月利息 ÷ ((期初余额 + 期末余额) ÷ 2) × 12`

- **期初余额**：上月月末在贷余额
- **期末余额**：当月月末在贷余额
- **月均余额**：`(期初 + 期末) / 2`
- **单月利息**：当月 `interest_income`
- **目标**：≥ 15%

### 2.3 回收率

**公式**：`回收率 = 实际回收 ÷ 应回收`

- **实际回收**：当月 `collection`（本金+利息+罚息+展期费）
- **应回收**：从 `raw_loan.repayment_schedule` 取当月 `due_date` 在当月内的应还金额（本金+利息）之和
- 若应回收为 0 且实际回收 > 0，则默认 98%

---

## 三、现金流预测页面

数据来源：`raw_loan.repayment_schedule`、`calc_overdue`。仅考虑**活跃贷款**（loan_status 1 或 2）。

### 3.1 计算逻辑

1. **活跃贷款**：从最新 `calc_overdue` 快照中取 `loan_status IN (1, 2)` 的 loan_id
2. **未来应还**：从 `raw_loan.repayment_schedule` 中取 `due_date > 今天` 的应还本金、应还利息
3. **按月汇总**：按 `due_date` 所在月份分组，汇总 principal、interest、loan_count
4. **预期回收**：`expected_inflow = (principal + interest) × collection_rate`

### 3.2 指标说明

| 指标 | 说明 |
|------|------|
| **应还本金 (principal)** | 该月到期应还本金之和 |
| **应还利息 (interest)** | 该月到期应还利息之和 |
| **预期回收 (expected_inflow)** | `(principal + interest) × 回收率`，默认回收率 98% |
| **涉及笔数 (loan_count)** | 该月有应还的贷款数量 |
| **12 个月预期回收** | 未来 12 个月 expected_inflow 之和 |

### 3.3 回收率来源

- 优先使用收益规模页面最新月 `collection_rate`
- 若无则默认 98%

---

## 四、文档维护

- **更新时机**：当 `kn_risk_query.py`、`kn_revenue.py`、`kn_cashflow.py`、`kn_vintage.py`、`kn_collection.py`、`spv_initial_params.py` 等模块中的指标算法发生变化时，请同步更新本文档。
- **文档位置**：`docs/help/指标计算说明.md`
- **在线查看**：网站内 Help 目录
