<!DOCTYPE html>
<html lang="zh-CN">
<head>
    {% include '_app_root.html' %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHUAN | {{ loan.loan_id }} - Loan 详情</title>
    <style>
        :root { --light-pink: #FFF1EE; --dark-blue: #3B4A6A; --white: #FFFFFF; --text-muted: #8A95A5; --border: #E2E8F0; --accent-teal: #2E7D6E; --accent-amber: #E8A838; --accent-coral: #D8434F; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: linear-gradient(135deg, #f5f0ee 0%, #ebe5e3 100%); min-height: 100vh; color: var(--dark-blue); }
        .top-bar { background: var(--dark-blue); color: var(--white); padding: 0 32px; height: 56px; display: flex; align-items: center; justify-content: space-between; }
        .top-bar .left { display: flex; align-items: center; gap: 24px; }
        .top-bar .logo { font-size: 1.1rem; font-weight: 700; letter-spacing: 2px; }
        .top-bar nav a { color: rgba(255,255,255,0.6); text-decoration: none; font-size: 0.82rem; padding: 6px 14px; border-radius: 6px; transition: all 0.15s; }
        .top-bar nav a:hover { color: var(--white); background: rgba(255,255,255,0.08); }
        .top-bar .user-info { display: flex; align-items: center; gap: 16px; font-size: 0.85rem; }
        .role-badge { padding: 3px 10px; border-radius: 4px; font-size: 0.72rem; font-weight: 600; background: rgba(255,241,238,0.15); color: var(--light-pink); }
        .btn-link { padding: 6px 14px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: var(--white); background: none; cursor: pointer; font-size: 0.8rem; text-decoration: none; }
        .btn-link:hover { background: rgba(255,255,255,0.1); }
        .page { max-width: 1200px; margin: 0 auto; padding: 24px; }
        .page-header { margin-bottom: 24px; }
        .btn-back { display: inline-flex; align-items: center; gap: 4px; font-size: 0.8rem; color: var(--dark-blue); text-decoration: none; padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--white); transition: all 0.15s; white-space: nowrap; }
        .btn-back:hover { background: var(--dark-blue); color: var(--white); }
        .page-header h1 { font-size: 1.25rem; font-weight: 700; margin-top: 12px; }
        .page-header .sub { font-size: 0.78rem; color: var(--text-muted); margin-top: 4px; }
        .section-title { font-size: 1rem; font-weight: 600; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--accent-teal); display: inline-block; }
        .section-block { background: var(--white); border-radius: 10px; padding: 20px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(59,74,106,0.08); overflow-x: auto; }
        .info-grid, .status-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 16px; }
        .info-item, .status-item { padding: 12px 16px; background: #F8FAFC; border-radius: 8px; }
        .info-item .label, .status-item .label { font-size: 0.72rem; color: var(--text-muted); margin-bottom: 4px; }
        .info-item .value, .status-item .value { font-size: 0.95rem; font-weight: 600; }
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.82rem; }
        .data-table th, .data-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border); }
        .data-table th { background: #F8FAFC; font-weight: 600; color: var(--text-muted); font-size: 0.72rem; text-transform: uppercase; }
        .data-table .num { text-align: right; font-variant-numeric: tabular-nums; }
        .data-table tr:hover { background: rgba(255,241,238,0.4); }
        .status-paid { color: var(--accent-teal); font-weight: 600; }
        .status-pending { color: var(--text-muted); }
        .empty-state { padding: 24px; text-align: center; color: var(--text-muted); font-size: 0.9rem; }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="left">
            <div class="logo">CHUAN</div>
            <nav>
                <a href="{{ app_root }}/dashboard">概览</a>
                <a href="{{ app_root }}/partner/manage">资产商管理</a>
                <a href="{{ app_root }}/help">Help</a>
                <a href="{{ app_root }}/partner/{{ partner.id }}/risk">{{ partner.name }}</a>
            </nav>
        </div>
        <div class="user-info">
            <span>{{ user.display_name }}</span>
            <span class="role-badge">{{ user.role_label }}</span>
            <a href="{{ app_root }}/logout" class="btn-link">退出</a>
        </div>
    </div>

    <div class="page">
        <div class="page-header">
            <a href="javascript:history.back()" class="btn-back">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                返回
            </a>
            <h1>{{ loan.loan_id }}</h1>
            <div class="sub">放款 ${{ "{:,.0f}".format(loan.disbursement_amount or 0) }} · {{ loan.loan_status or 'active' }} · DPD {{ loan.dpd or 0 }}{% if loan.outstanding_principal %} · 未偿本金 ${{ "{:,.0f}".format(loan.outstanding_principal) }}{% endif %}</div>
        </div>

        <!-- 合同信息 -->
        {% if contract_no and contract_no != '-' %}
        <div class="section-title">合同信息</div>
        <div class="section-block">
            <div class="status-grid">
                <div class="status-item"><div class="label">合同号</div><div class="value">{{ contract_no }}</div></div>
            </div>
        </div>
        {% endif %}

        <!-- Loan 基础信息 -->
        <div class="section-title">Loan 基础信息</div>
        <div class="section-block">
            <div class="status-grid">
                <div class="status-item"><div class="label">Loan ID</div><div class="value">{{ loan.loan_id }}</div></div>
                <div class="status-item"><div class="label">放款时间</div><div class="value">{{ (loan.disbursement_time|string)[:10] if loan.disbursement_time else '-' }}</div></div>
                <div class="status-item"><div class="label">放款金额</div><div class="value">${{ "{:,.0f}".format(loan.disbursement_amount or 0) }}</div></div>
                <div class="status-item"><div class="label">期限(月)</div><div class="value">{{ loan.term_month or loan.term_months or '-' }}</div></div>
                <div class="status-item"><div class="label">到期日</div><div class="value">{{ (loan.loan_maturity_date|string)[:10] if loan.loan_maturity_date else '-' }}</div></div>
                <div class="status-item"><div class="label">客户ID</div><div class="value">{{ loan.customer_id or '-' }}</div></div>
                <div class="status-item"><div class="label">合同号</div><div class="value">{{ loan.contract_no or loan.get('contract_no') or '-' }}</div></div>
                <div class="status-item"><div class="label">DPD</div><div class="value">{{ loan.dpd or 0 }}</div></div>
                <div class="status-item"><div class="label">未偿本金</div><div class="value">${{ "{:,.0f}".format(loan.outstanding_principal or 0) }}</div></div>
            </div>
        </div>

        <!-- 客户基础信息 -->
        <div class="section-title">客户基础信息</div>
        <div class="section-block">
            <div class="info-grid">
                <div class="info-item"><div class="label">信用评级</div><div class="value">{{ customer_info.credit_rating|default('-') }}</div></div>
                <div class="info-item"><div class="label">行业</div><div class="value">{{ customer_info.industry|default('-') }}</div></div>
                <div class="info-item"><div class="label">地区</div><div class="value">{{ customer_info.region|default('-') }}</div></div>
                <div class="info-item"><div class="label">教育程度</div><div class="value">{{ customer_info.education|default('-') }}</div></div>
            </div>
        </div>

        <!-- 还款计划 -->
        <div class="section-title">还款计划{% if schedule %}（共 {{ schedule|length }} 期）{% endif %}</div>
        <div class="section-block">
            {% if schedule %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>期次</th>
                        <th>还款日期</th>
                        <th class="num">应还本金</th>
                        <th class="num">应还利息</th>
                        <th class="num">应还总额</th>
                        <th>状态</th>
                    </tr>
                </thead>
                <tbody>
                    {% for s in schedule %}
                    <tr>
                        <td>{{ s.period or s.period_no }}</td>
                        <td>{{ (s.due_date|string)[:10] if s.due_date else '-' }}</td>
                        <td class="num">${{ "{:,.2f}".format(s.principal_due or s.principal or 0) }}</td>
                        <td class="num">${{ "{:,.2f}".format(s.interest_due or s.interest or 0) }}</td>
                        <td class="num">${{ "{:,.2f}".format(s.total_due or s.total or 0) }}</td>
                        <td class="status-{{ s.status|default('pending') }}">{{ '已还' if s.status == 'paid' else '待还' }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">暂无还款计划</div>
            {% endif %}
        </div>

        <!-- 还款信息 -->
        <div class="section-title">还款信息</div>
        <div class="section-block">
            {% if repayments %}
            <table class="data-table">
                <thead>
                    <tr>
                        <th>还款类型</th>
                        <th>还款日期</th>
                        <th class="num">期次</th>
                        <th class="num">还款金额</th>
                        <th class="num">还款本金</th>
                        <th class="num">还款利息</th>
                        <th class="num">还款罚息</th>
                        <th class="num">展期费</th>
                        <th class="num">Waive</th>
                        <th>交易ID</th>
                        <th>是否结清</th>
                    </tr>
                </thead>
                <tbody>
                    {% for r in repayments %}
                    <tr>
                        <td>{% if r.repayment_type == 1 or r.repayment_type == '1' %}按期{% elif r.repayment_type == 2 or r.repayment_type == '2' %}提前结清{% elif r.repayment_type == 3 or r.repayment_type == '3' %}展期结清{% elif r.repayment_type == 4 or r.repayment_type == '4' %}部分还清{% elif r.repayment_type == 5 or r.repayment_type == '5' %}逾期还款{% else %}{{ r.repayment_type or '-' }}{% endif %}</td>
                        <td>{{ (r.repayment_date|string)[:10] if r.repayment_date else (r.payment_date|string)[:10] if r.payment_date else '-' }}</td>
                        <td class="num">{{ r.repayment_term or r.period or '-' }}</td>
                        <td class="num">${{ "{:,.2f}".format(r.total_repayment or r.amount or 0) }}</td>
                        <td class="num">${{ "{:,.2f}".format(r.principal_repayment or r.principal_paid or 0) }}</td>
                        <td class="num">${{ "{:,.2f}".format(r.interest_repayment or r.interest_paid or 0) }}</td>
                        <td class="num">${{ "{:,.2f}".format(r.penalty_repayment or r.penalty_paid or 0) }}</td>
                        <td class="num">${{ "{:,.2f}".format(r.extension_fee or 0) }}</td>
                        <td class="num">${{ "{:,.2f}".format(r.waiver_amount or r.waive_amount or 0) }}</td>
                        <td>{{ r.repayment_txn_id or '-' }}</td>
                        <td>{% if r.is_settled == true or r.is_settled == 1 or r.is_settled == '1' %}是{% elif r.is_settled == false or r.is_settled == 0 or r.is_settled == '0' %}否{% else %}{{ r.is_settled or '-' }}{% endif %}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            {% else %}
            <div class="empty-state">暂无还款记录</div>
            {% endif %}
        </div>
    </div>
</body>
</html>
