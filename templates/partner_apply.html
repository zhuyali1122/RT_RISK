<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHUAN | 资产商申请</title>
    <style>
        :root {
            --light-pink: #FFF1EE;
            --dark-blue: #3B4A6A;
            --white: #FFFFFF;
            --text-muted: #8A95A5;
            --border: #E2E8F0;
            --green: #2E7D6E;
            --red: #D8434F;
            --gold: #C9A96E;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: var(--light-pink); color: var(--dark-blue); }

        .top-bar {
            background: var(--dark-blue); color: var(--white); padding: 0 32px; height: 56px;
            display: flex; align-items: center; justify-content: space-between;
        }
        .top-bar .left { display: flex; align-items: center; gap: 24px; }
        .top-bar .logo { font-size: 1.1rem; font-weight: 700; letter-spacing: 2px; }
        .top-bar nav { display: flex; gap: 4px; }
        .top-bar nav a { color: rgba(255,255,255,0.6); text-decoration: none; font-size: 0.82rem; padding: 6px 14px; border-radius: 6px; transition: all 0.15s; }
        .top-bar nav a:hover { color: var(--white); background: rgba(255,255,255,0.08); }
        .top-bar nav a.active { color: var(--white); background: rgba(255,241,238,0.15); font-weight: 600; }
        .top-bar .user-info { display: flex; align-items: center; gap: 16px; font-size: 0.85rem; }
        .role-badge { padding: 3px 10px; border-radius: 4px; font-size: 0.72rem; font-weight: 600; background: rgba(255,241,238,0.15); color: var(--light-pink); }
        .btn-link { padding: 6px 14px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: var(--white); background: none; cursor: pointer; font-size: 0.8rem; text-decoration: none; }
        .btn-link:hover { background: rgba(255,255,255,0.1); }

        .page { max-width: 1100px; margin: 0 auto; padding: 28px 24px 48px; }

        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; }
        .page-header .left-group { display: flex; align-items: center; gap: 12px; }
        .page-header h1 { font-size: 1.35rem; font-weight: 700; }
        .btn-back {
            display: inline-flex; align-items: center; gap: 4px; font-size: 0.8rem; color: var(--dark-blue);
            text-decoration: none; padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--white); transition: all 0.15s; white-space: nowrap;
        }
        .btn-back:hover { background: var(--dark-blue); color: var(--white); }

        /* Steps indicator */
        .steps { display: flex; align-items: center; gap: 0; margin-bottom: 28px; }
        .step {
            display: flex; align-items: center; gap: 8px; padding: 10px 20px;
            background: var(--white); border: 1px solid var(--border); font-size: 0.82rem; color: var(--text-muted);
            cursor: pointer; transition: all 0.15s; position: relative;
        }
        .step:first-child { border-radius: 8px 0 0 8px; }
        .step:last-child { border-radius: 0 8px 8px 0; }
        .step.active { background: var(--dark-blue); color: var(--white); border-color: var(--dark-blue); font-weight: 600; z-index: 1; }
        .step-num {
            width: 22px; height: 22px; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 0.7rem; font-weight: 700; background: var(--border); color: var(--text-muted);
        }
        .step.active .step-num { background: rgba(255,241,238,0.25); color: var(--white); }
        .step.done .step-num { background: var(--green); color: var(--white); }
        .step.done { color: var(--green); }

        /* Panels */
        .panel { display: none; }
        .panel.active { display: block; }

        /* Step 1: Basic info form */
        .card { background: var(--white); border-radius: 10px; padding: 28px; border: 1px solid var(--border); margin-bottom: 16px; }
        .card-title { font-size: 0.88rem; font-weight: 700; margin-bottom: 20px; display: flex; align-items: center; gap: 8px; }
        .card-title::before { content: ''; width: 3px; height: 16px; background: var(--dark-blue); border-radius: 2px; }

        .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .form-group { display: flex; flex-direction: column; gap: 6px; }
        .form-group.full { grid-column: 1 / -1; }
        .form-label { font-size: 0.78rem; font-weight: 600; color: var(--dark-blue); }
        .form-label .req { color: var(--red); margin-left: 2px; }
        .form-input, .form-select, .form-textarea {
            padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 8px;
            font-size: 0.85rem; color: var(--dark-blue); background: #F8FAFC; outline: none;
            font-family: inherit; transition: border-color 0.15s;
        }
        .form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--dark-blue); background: var(--white); }
        .form-textarea { resize: vertical; min-height: 80px; }

        /* Step 2: DD modules */
        .dd-modules { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        .dd-module {
            background: var(--white); border-radius: 10px; border: 1px solid var(--border);
            overflow: hidden; transition: box-shadow 0.15s;
        }
        .dd-module:hover { box-shadow: 0 4px 12px rgba(59,74,106,0.08); }
        .dd-header {
            padding: 18px 20px; display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--border);
        }
        .dd-header-left { display: flex; align-items: center; gap: 10px; }
        .dd-icon { font-size: 1.3rem; }
        .dd-name { font-size: 0.88rem; font-weight: 700; }
        .dd-name-en { font-size: 0.68rem; color: var(--text-muted); }
        .dd-progress { font-size: 0.72rem; font-weight: 600; }

        .dd-body { padding: 16px 20px; }

        .dd-item {
            display: flex; align-items: center; justify-content: space-between;
            padding: 10px 0; border-bottom: 1px solid #F5F5F5; gap: 8px;
        }
        .dd-item:last-child { border-bottom: none; }
        .dd-item-left { display: flex; align-items: center; gap: 10px; flex: 1; min-width: 0; }
        .dd-item-name { font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .dd-item-req { font-size: 0.6rem; color: var(--red); font-weight: 600; flex-shrink: 0; }
        .dd-item-opt { font-size: 0.6rem; color: var(--text-muted); flex-shrink: 0; }

        .dd-item-actions { display: flex; align-items: center; gap: 6px; flex-shrink: 0; }

        .btn-sm {
            padding: 5px 10px; border-radius: 5px; font-size: 0.7rem; cursor: pointer;
            border: 1px solid var(--border); background: var(--white); color: var(--dark-blue);
            transition: all 0.15s; display: inline-flex; align-items: center; gap: 4px; text-decoration: none;
        }
        .btn-sm:hover { background: var(--light-pink); }
        .btn-sm svg { width: 12px; height: 12px; fill: currentColor; }

        .btn-sm.upload { border-color: var(--dark-blue); }
        .btn-sm.upload:hover { background: var(--dark-blue); color: var(--white); }

        .btn-sm.done { background: #E8F5E9; color: var(--green); border-color: #C8E6C9; }

        .file-name { font-size: 0.68rem; color: var(--green); max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .dd-footer {
            padding: 12px 20px; background: #F8FAFC; border-top: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .btn-download-all {
            padding: 7px 14px; border-radius: 6px; font-size: 0.75rem; cursor: pointer;
            border: 1px solid var(--dark-blue); background: var(--white); color: var(--dark-blue);
            display: inline-flex; align-items: center; gap: 5px; text-decoration: none; transition: all 0.15s;
        }
        .btn-download-all:hover { background: var(--dark-blue); color: var(--white); }
        .btn-download-all svg { width: 14px; height: 14px; fill: currentColor; }

        /* Step 3: Review */
        .review-section { margin-bottom: 20px; }
        .review-title { font-size: 0.82rem; font-weight: 700; margin-bottom: 10px; color: var(--dark-blue); }
        .review-row { display: flex; padding: 8px 0; border-bottom: 1px solid #F5F5F5; font-size: 0.8rem; }
        .review-label { width: 140px; color: var(--text-muted); flex-shrink: 0; }
        .review-value { flex: 1; font-weight: 500; }
        .review-status { display: inline-flex; align-items: center; gap: 4px; font-size: 0.75rem; font-weight: 600; }
        .review-status.ok { color: var(--green); }
        .review-status.pending { color: var(--gold); }
        .review-status.missing { color: var(--red); }

        /* Action bar */
        .action-bar {
            display: flex; justify-content: space-between; align-items: center; margin-top: 28px;
            padding-top: 20px; border-top: 1px solid var(--border);
        }
        .btn-primary {
            padding: 10px 28px; border-radius: 8px; font-size: 0.88rem; font-weight: 600; cursor: pointer;
            border: none; background: var(--dark-blue); color: var(--white); transition: all 0.15s; letter-spacing: 0.5px;
        }
        .btn-primary:hover { background: #4A5B7A; box-shadow: 0 4px 12px rgba(59,74,106,0.25); }
        .btn-secondary {
            padding: 10px 24px; border-radius: 8px; font-size: 0.85rem; cursor: pointer;
            border: 1px solid var(--border); background: var(--white); color: var(--dark-blue); transition: all 0.15s;
        }
        .btn-secondary:hover { background: var(--light-pink); }

        .hidden-input { display: none; }

        @media (max-width: 768px) {
            .form-grid { grid-template-columns: 1fr; }
            .dd-modules { grid-template-columns: 1fr; }
            .steps { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="left">
            <div class="logo">CHUAN</div>
            <nav>
                <a href="/dashboard">概览</a>
                <a href="/partner/apply" class="active">资产商申请</a>
            </nav>
        </div>
        <div class="user-info">
            <span>{{ user.display_name }}</span>
            <span class="role-badge">{{ user.role_label }}</span>
            <a href="/logout" class="btn-link">退出</a>
        </div>
    </div>

    <div class="page">
        <div class="page-header">
            <div class="left-group">
                <a href="/dashboard" class="btn-back">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                    返回
                </a>
                <h1>资产商申请</h1>
            </div>
        </div>

        <!-- Steps -->
        <div class="steps">
            <div class="step active" data-step="1" onclick="goStep(1)">
                <div class="step-num">1</div>
                <span>基本信息</span>
            </div>
            <div class="step" data-step="2" onclick="goStep(2)">
                <div class="step-num">2</div>
                <span>尽调文件</span>
            </div>
            <div class="step" data-step="3" onclick="goStep(3)">
                <div class="step-num">3</div>
                <span>审核提交</span>
            </div>
        </div>

        <!-- Step 1: 基本信息 -->
        <div class="panel active" id="panel1">
            <div class="card">
                <div class="card-title">资产商基本信息</div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label">公司名称 <span class="req">*</span></label>
                        <input class="form-input" id="companyName" placeholder="请输入资产商全称">
                    </div>
                    <div class="form-group">
                        <label class="form-label">英文名称</label>
                        <input class="form-input" id="companyNameEn" placeholder="Company Name (English)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">注册国家/地区 <span class="req">*</span></label>
                        <select class="form-select" id="country">
                            <option value="">请选择</option>
                            <option>印度尼西亚</option>
                            <option>菲律宾</option>
                            <option>越南</option>
                            <option>泰国</option>
                            <option>墨西哥</option>
                            <option>巴西</option>
                            <option>哥伦比亚</option>
                            <option>尼日利亚</option>
                            <option>肯尼亚</option>
                            <option>巴基斯坦</option>
                            <option>中国香港</option>
                            <option>新加坡</option>
                            <option>其他</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">产品类型 <span class="req">*</span></label>
                        <select class="form-select" id="productType">
                            <option value="">请选择</option>
                            <option>个人消费贷 (PL)</option>
                            <option>商户现金预支 (MCA)</option>
                            <option>PL + MCA</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">月放贷规模 (USD) <span class="req">*</span></label>
                        <input class="form-input" id="monthlyVolume" placeholder="例: 5,000,000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">运营年限</label>
                        <input class="form-input" id="yearsOp" placeholder="例: 3年">
                    </div>
                    <div class="form-group">
                        <label class="form-label">联系人 <span class="req">*</span></label>
                        <input class="form-input" id="contactPerson" placeholder="姓名">
                    </div>
                    <div class="form-group">
                        <label class="form-label">联系邮箱 <span class="req">*</span></label>
                        <input class="form-input" id="contactEmail" placeholder="email@example.com">
                    </div>
                    <div class="form-group full">
                        <label class="form-label">申请备注</label>
                        <textarea class="form-textarea" id="notes" placeholder="其他需要说明的信息..."></textarea>
                    </div>
                </div>
            </div>
            <div class="action-bar">
                <div></div>
                <button class="btn-primary" onclick="goStep(2)">下一步：尽调文件 →</button>
            </div>
        </div>

        <!-- Step 2: 尽调文件 -->
        <div class="panel" id="panel2">
            <div class="dd-modules" id="ddModules"></div>
            <div class="action-bar">
                <button class="btn-secondary" onclick="goStep(1)">← 上一步</button>
                <button class="btn-primary" onclick="goStep(3)">下一步：审核提交 →</button>
            </div>
        </div>

        <!-- Step 3: 审核提交 -->
        <div class="panel" id="panel3">
            <div class="card">
                <div class="card-title">申请信息确认</div>
                <div class="review-section">
                    <div class="review-title">基本信息</div>
                    <div id="reviewBasic"></div>
                </div>
                <div class="review-section">
                    <div class="review-title">尽调文件状态</div>
                    <div id="reviewDD"></div>
                </div>
            </div>
            <div class="action-bar">
                <button class="btn-secondary" onclick="goStep(2)">← 上一步</button>
                <button class="btn-primary" onclick="submitApplication()">提交申请</button>
            </div>
        </div>
    </div>

    <script>
        const ddConfig = {{ dd_checklist | tojson }};
        const uploadedFiles = {};

        /* ---- Steps ---- */
        function goStep(n) {
            document.querySelectorAll('.step').forEach(s => {
                const sn = +s.dataset.step;
                s.classList.remove('active','done');
                if (sn === n) s.classList.add('active');
                else if (sn < n) s.classList.add('done');
            });
            document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
            document.getElementById('panel' + n).classList.add('active');
            if (n === 3) buildReview();
            window.scrollTo(0, 0);
        }

        /* ---- Build DD Modules ---- */
        function buildDDModules() {
            const container = document.getElementById('ddModules');
            ddConfig.modules.forEach(mod => {
                let itemsHtml = '';
                mod.items.forEach(item => {
                    const reqTag = item.required
                        ? '<span class="dd-item-req">必填</span>'
                        : '<span class="dd-item-opt">选填</span>';
                    itemsHtml += `
                    <div class="dd-item" id="item-${item.id}">
                        <div class="dd-item-left">
                            ${reqTag}
                            <span class="dd-item-name" title="${item.name}">${item.name}</span>
                        </div>
                        <div class="dd-item-actions">
                            <span class="file-name" id="fname-${item.id}"></span>
                            <label class="btn-sm upload" for="file-${item.id}">
                                <svg viewBox="0 0 24 24"><path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/></svg>
                                上传
                            </label>
                            <input type="file" class="hidden-input" id="file-${item.id}" onchange="handleUpload('${item.id}', this)">
                        </div>
                    </div>`;
                });

                container.innerHTML += `
                <div class="dd-module">
                    <div class="dd-header">
                        <div class="dd-header-left">
                            <span class="dd-icon">${mod.icon}</span>
                            <div>
                                <div class="dd-name">${mod.name}</div>
                                <div class="dd-name-en">${mod.name_en}</div>
                            </div>
                        </div>
                        <span class="dd-progress" id="progress-${mod.id}" style="color:${mod.color}">0/${mod.items.length}</span>
                    </div>
                    <div class="dd-body">${itemsHtml}</div>
                    <div class="dd-footer">
                        <a href="/api/dd/template/${mod.id}" class="btn-download-all" target="_blank">
                            <svg viewBox="0 0 24 24"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                            下载尽调模板
                        </a>
                        <span style="font-size:0.7rem;color:var(--text-muted)" id="status-${mod.id}"></span>
                    </div>
                </div>`;
            });
        }

        /* ---- Upload ---- */
        function handleUpload(itemId, input) {
            if (!input.files.length) return;
            const file = input.files[0];

            const formData = new FormData();
            formData.append('file', file);
            formData.append('item_id', itemId);

            fetch('/api/dd/upload', { method: 'POST', body: formData })
                .then(r => r.json())
                .then(res => {
                    if (res.success) {
                        uploadedFiles[itemId] = file.name;
                        const fnameEl = document.getElementById('fname-' + itemId);
                        fnameEl.textContent = file.name;

                        const label = input.previousElementSibling ? null :
                            input.parentElement.querySelector('.upload');
                        updateModuleProgress();
                    }
                })
                .catch(() => {
                    uploadedFiles[itemId] = file.name;
                    document.getElementById('fname-' + itemId).textContent = file.name;
                    updateModuleProgress();
                });
        }

        function updateModuleProgress() {
            ddConfig.modules.forEach(mod => {
                const uploaded = mod.items.filter(it => uploadedFiles[it.id]).length;
                document.getElementById('progress-' + mod.id).textContent = uploaded + '/' + mod.items.length;
                const statusEl = document.getElementById('status-' + mod.id);
                const required = mod.items.filter(it => it.required);
                const reqDone = required.filter(it => uploadedFiles[it.id]).length;
                if (reqDone === required.length) {
                    statusEl.textContent = '✓ 必填项已完成';
                    statusEl.style.color = 'var(--green)';
                } else {
                    statusEl.textContent = `必填 ${reqDone}/${required.length}`;
                    statusEl.style.color = 'var(--gold)';
                }
            });
        }

        /* ---- Review ---- */
        function buildReview() {
            const fields = [
                ['公司名称', document.getElementById('companyName').value],
                ['英文名称', document.getElementById('companyNameEn').value],
                ['注册国家/地区', document.getElementById('country').value],
                ['产品类型', document.getElementById('productType').value],
                ['月放贷规模', document.getElementById('monthlyVolume').value],
                ['运营年限', document.getElementById('yearsOp').value],
                ['联系人', document.getElementById('contactPerson').value],
                ['联系邮箱', document.getElementById('contactEmail').value],
            ];
            const basicEl = document.getElementById('reviewBasic');
            basicEl.innerHTML = fields.map(([l, v]) =>
                `<div class="review-row"><div class="review-label">${l}</div><div class="review-value">${v || '<span style="color:var(--text-muted)">—</span>'}</div></div>`
            ).join('');

            const ddEl = document.getElementById('reviewDD');
            let ddHtml = '';
            ddConfig.modules.forEach(mod => {
                const required = mod.items.filter(it => it.required);
                const reqDone = required.filter(it => uploadedFiles[it.id]).length;
                const total = mod.items.length;
                const uploaded = mod.items.filter(it => uploadedFiles[it.id]).length;
                let statusCls = 'missing', statusText = `${reqDone}/${required.length} 必填项`;
                if (reqDone === required.length) { statusCls = 'ok'; statusText = `已完成 (${uploaded}/${total})`; }
                else if (reqDone > 0) { statusCls = 'pending'; }

                ddHtml += `<div class="review-row">
                    <div class="review-label">${mod.icon} ${mod.name}</div>
                    <div class="review-value"><span class="review-status ${statusCls}">${statusCls === 'ok' ? '✓' : statusCls === 'pending' ? '◐' : '✗'} ${statusText}</span></div>
                </div>`;
            });
            ddEl.innerHTML = ddHtml;
        }

        /* ---- Submit ---- */
        function submitApplication() {
            const name = document.getElementById('companyName').value.trim();
            if (!name) { alert('请填写公司名称'); goStep(1); return; }

            let allReqDone = true;
            ddConfig.modules.forEach(mod => {
                mod.items.filter(it => it.required).forEach(it => {
                    if (!uploadedFiles[it.id]) allReqDone = false;
                });
            });

            if (!allReqDone) {
                if (!confirm('尚有必填尽调文件未上传，是否仍要提交？')) return;
            }

            alert('申请已提交！审核结果将通过邮件通知。');
        }

        buildDDModules();
    </script>
</body>
</html>
