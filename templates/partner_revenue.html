<!DOCTYPE html>
<html lang="zh-CN">
<head>
    {% include '_app_root.html' %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CHUAN | {{ partner.name }} - 收益规模</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root { --light-pink: #FFF1EE; --dark-blue: #3B4A6A; --white: #FFFFFF; --text-muted: #8A95A5; --border: #E2E8F0; --green: #2E7D6E; --red: #D8434F; --gold: #C9A96E; --teal: #4DB6AC; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, "PingFang SC", sans-serif; background: linear-gradient(135deg, #f5f0ee 0%, #ebe5e3 100%); min-height: 100vh; color: var(--dark-blue); padding-bottom: 24px; }
        .data-source-status { position: fixed; bottom: 0; left: 0; right: 0; height: 24px; background: var(--dark-blue); color: rgba(255,255,255,0.85); font-size: 0.72rem; display: flex; align-items: center; justify-content: center; gap: 6px; z-index: 1000; }
        .data-source-status .ds-label { opacity: 0.8; }
        .data-source-status .ds-value { font-weight: 600; }
        .data-source-status .ds-cache { color: #7DD3C0; }
        .data-source-status .ds-database { color: #F9A825; }

        .top-bar { background: var(--dark-blue); color: var(--white); padding: 0 32px; height: 56px; display: flex; align-items: center; justify-content: space-between; }
        .top-bar .left { display: flex; align-items: center; gap: 24px; }
        .top-bar .logo { font-size: 1.1rem; font-weight: 700; letter-spacing: 2px; }
        .top-bar nav { display: flex; gap: 4px; }
        .top-bar nav a { color: rgba(255,255,255,0.6); text-decoration: none; font-size: 0.82rem; padding: 6px 14px; border-radius: 6px; transition: all 0.15s; }
        .top-bar nav a:hover { color: var(--white); background: rgba(255,255,255,0.08); }
        .top-bar nav a.active { color: var(--white); background: rgba(255,241,238,0.15); font-weight: 600; }
        .top-bar .user-info { display: flex; align-items: center; gap: 16px; font-size: 0.85rem; }
        .role-badge { padding: 3px 10px; border-radius: 4px; font-size: 0.72rem; font-weight: 600; background: rgba(255,241,238,0.15); color: var(--light-pink); }
        .btn-link { padding: 6px 14px; border: 1px solid rgba(255,255,255,0.3); border-radius: 6px; color: var(--white); background: none; cursor: pointer; font-size: 0.8rem; text-decoration: none; }

        .page { max-width: 1400px; margin: 0 auto; padding: 24px; }
        .page-header { display: flex; justify-content: space-between; align-items: flex-end; margin-bottom: 24px; }
        .page-header .header-right { display: flex; align-items: center; gap: 24px; }
        .page-header .left-group { display: flex; align-items: center; gap: 12px; }
        .currency-selector { flex-direction: column; align-items: flex-end; gap: 4px; }
        .currency-selector .currency-selector-row { display: flex; align-items: center; gap: 10px; }
        .currency-selector label { font-size: 0.8rem; color: var(--text-muted); }
        .currency-selector .exchange-rate-hint { font-size: 0.7rem; color: var(--text-muted); text-align: right; }
        .currency-toggle { display: inline-flex; border: 1px solid var(--border); border-radius: 6px; overflow: hidden; font-size: 0.72rem; }
        .currency-toggle button { padding: 4px 12px; border: none; background: var(--white); color: var(--text-muted); cursor: pointer; font-weight: 600; font-family: inherit; transition: all 0.15s; }
        .currency-toggle button.active { background: var(--dark-blue); color: var(--white); }
        .currency-toggle button:hover:not(.active) { background: var(--light-pink); }
        .page-header h1 { font-size: 1.25rem; font-weight: 700; }
        .page-header .sub { font-size: 0.78rem; color: var(--text-muted); margin-top: 2px; }
        .btn-back { display: inline-flex; align-items: center; gap: 4px; font-size: 0.8rem; color: var(--dark-blue); text-decoration: none; padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border); background: var(--white); transition: all 0.15s; white-space: nowrap; }
        .btn-back:hover { background: var(--dark-blue); color: var(--white); }
        .cache-status { font-size: 0.72rem; color: var(--text-muted); margin-right: 12px; }
        .cache-empty { color: var(--gold); }
        .btn-refresh { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border: 1px solid var(--border); border-radius: 6px; background: var(--white); color: var(--dark-blue); font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.15s; margin-right: 16px; }
        .btn-refresh:hover { background: var(--green); color: var(--white); border-color: var(--green); }
        .btn-refresh:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-refresh.loading svg { animation: spin 0.8s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
        .btn-pdf { display: inline-flex; align-items: center; gap: 6px; padding: 6px 14px; border: 1px solid var(--border); border-radius: 6px; background: var(--white); color: var(--dark-blue); font-size: 0.8rem; font-weight: 600; cursor: pointer; transition: all 0.15s; margin-right: 8px; }
        .btn-pdf:hover { background: var(--green); color: var(--white); border-color: var(--green); }
        .btn-pdf:disabled { opacity: 0.6; cursor: not-allowed; }
        .btn-pdf.loading svg { animation: spin 0.8s linear infinite; }

        /* PDF 导出：仅保留内容，隐藏按钮/选择器等 */
        body.pdf-export .data-source-status { display: none !important; }
        body.pdf-export .btn-back,
        body.pdf-export .btn-pdf,
        body.pdf-export .btn-refresh,
        body.pdf-export .cache-status,
        body.pdf-export .header-right,
        body.pdf-export .no-pdf,
        body.pdf-export .help-icon,
        body.pdf-export .yield-breakdown,
        body.pdf-export .collection-breakdown { display: none !important; }
        body.pdf-export .page { max-width: 190mm; padding: 16px; background: #fff; }
        body.pdf-export .page-header .left-group { margin-left: 0; }
        body.pdf-export .kpi-card,
        body.pdf-export .chart-panel,
        body.pdf-export .table-panel { break-inside: avoid; page-break-inside: avoid; }
        body.pdf-export .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
        body.pdf-export .bar-chart,
        body.pdf-export .stacked-bar-chart { height: 140px; }
        body.pdf-export .dual-axis-svg,
        body.pdf-export .line-wrap svg { max-height: 140px; }

        .section-title { font-size: 1rem; font-weight: 600; margin-bottom: 16px; padding-bottom: 8px; border-bottom: 2px solid var(--green); display: inline-block; }

        .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 14px; margin-bottom: 28px; }
        .kpi-card { background: var(--white); border-radius: 10px; padding: 16px; box-shadow: 0 2px 8px rgba(59,74,106,0.08); border-left: 4px solid var(--dark-blue); }
        .kpi-card.green { border-left-color: var(--green); }
        .kpi-card.gold { border-left-color: var(--gold); }
        .kpi-label { font-size: 0.7rem; color: var(--dark-blue); opacity: 0.75; margin-bottom: 4px; }
        .kpi-value { font-size: 1.25rem; font-weight: 700; }
        .kpi-sub { font-size: 0.65rem; color: var(--text-muted); margin-top: 2px; }
        .kpi-sub.up { color: var(--green); }
        .kpi-sub.down { color: var(--red); }

        .kpi-label-with-help { display: flex; align-items: center; gap: 4px; position: relative; }
        .help-icon { width: 14px; height: 14px; border-radius: 50%; border: 1px solid var(--text-muted); color: var(--text-muted); font-size: 0.65rem; font-weight: 600; cursor: help; display: inline-flex; align-items: center; justify-content: center; flex-shrink: 0; }
        .help-icon:hover { border-color: var(--dark-blue); color: var(--dark-blue); }
        .yield-breakdown { display: none; position: absolute; left: 0; top: 100%; margin-top: 8px; background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; box-shadow: 0 4px 16px rgba(59,74,106,0.15); font-size: 0.75rem; z-index: 100; min-width: 280px; }
        .yield-breakdown.show { display: block; }
        .yield-breakdown-title { font-weight: 600; margin-bottom: 8px; color: var(--dark-blue); }
        .yield-breakdown-formula { background: #F8FAFC; padding: 8px 10px; border-radius: 6px; margin: 8px 0; font-family: monospace; font-size: 0.7rem; line-height: 1.5; }
        .yield-breakdown-table { width: 100%; border-collapse: collapse; font-size: 0.72rem; }
        .yield-breakdown-table td { padding: 4px 0; }
        .yield-breakdown-table td:first-child { color: var(--text-muted); }
        .yield-breakdown-table td:last-child { text-align: right; font-weight: 600; }
        .collection-breakdown { display: none; position: absolute; left: 0; top: 100%; margin-top: 8px; background: var(--white); border: 1px solid var(--border); border-radius: 8px; padding: 12px 16px; box-shadow: 0 4px 16px rgba(59,74,106,0.15); font-size: 0.75rem; z-index: 100; min-width: 260px; }
        .collection-breakdown.show { display: block; }
        .collection-breakdown .yield-breakdown-title { font-weight: 600; margin-bottom: 8px; color: var(--dark-blue); }
        .collection-breakdown .yield-breakdown-formula { background: #F8FAFC; padding: 8px 10px; border-radius: 6px; margin: 8px 0; font-family: monospace; font-size: 0.7rem; line-height: 1.5; }
        .collection-breakdown .yield-breakdown-table { width: 100%; border-collapse: collapse; font-size: 0.72rem; }
        .collection-breakdown .yield-breakdown-table td { padding: 4px 0; }
        .collection-breakdown .yield-breakdown-table td:first-child { color: var(--text-muted); }
        .collection-breakdown .yield-breakdown-table td:last-child { text-align: right; font-weight: 600; }
        .kpi-card.yield-card { position: relative; }
        .kpi-card.collection-card { position: relative; }
        .line-value-label { font-size: 9px; fill: var(--gold); font-weight: 600; text-anchor: middle; }
        .cr-chart-wrap svg { preserve-aspect-ratio: xMidYMid meet; }

        .charts-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 28px; }
        .chart-panel { background: var(--white); border-radius: 10px; padding: 20px; box-shadow: 0 2px 8px rgba(59,74,106,0.08); }
        .chart-title { font-size: 0.85rem; font-weight: 600; margin-bottom: 14px; }

        .bar-chart { display: flex; align-items: flex-end; gap: 8px; height: 180px; padding: 0 4px; }
        .bar-group { flex: 1; min-width: 0; display: flex; flex-direction: column; align-items: center; }
        .bar-pair { display: flex; gap: 4px; align-items: flex-end; justify-content: center; width: 100%; height: 140px; min-height: 140px; }
        .bar-pair > div { flex: 1; max-width: 28px; min-width: 14px; display: flex; flex-direction: column; align-items: center; justify-content: flex-end; height: 140px; }
        .bar-seg { width: 100%; min-width: 8px; border-radius: 3px 3px 0 0; transition: height 0.3s; }
        .bar-seg.disb { background: var(--dark-blue); }
        .bar-seg.coll { background: var(--teal); }
        .bar-month { font-size: 0.62rem; color: var(--text-muted); margin-top: 6px; }
        .bar-values { font-size: 0.58rem; color: var(--text-muted); margin-top: 2px; display: flex; gap: 4px; justify-content: center; }
        .bar-values .disb { color: var(--dark-blue); }
        .bar-values .coll { color: var(--teal); }

        .stacked-bar-chart { display: flex; align-items: flex-end; gap: 8px; height: 180px; padding: 0 4px; }
        .stacked-bar-group { flex: 1; min-width: 0; display: flex; flex-direction: column; align-items: center; }
        .stacked-bar-wrap { display: flex; flex-direction: column; justify-content: flex-end; align-items: center; width: 100%; height: 140px; min-height: 140px; }
        .stacked-bar-seg { width: 100%; min-width: 12px; max-width: 40px; border-radius: 2px 2px 0 0; transition: height 0.3s; }
        .stacked-bar-seg.interest { background: var(--green); }
        .stacked-bar-seg.fee { background: var(--teal); }
        .stacked-bar-month { font-size: 0.62rem; color: var(--text-muted); margin-top: 6px; }
        .stacked-bar-values { font-size: 0.58rem; color: var(--text-muted); margin-top: 2px; text-align: center; }
        .stacked-bar-values .interest { color: var(--green); }
        .stacked-bar-values .fee { color: var(--teal); }

        .line-wrap { position: relative; height: 160px; }
        .line-wrap svg { width: 100%; height: 100%; }
        .dual-axis-chart { display: flex; flex-direction: column; gap: 8px; }
        .dual-axis-header { display: flex; justify-content: space-between; align-items: center; font-size: 0.7rem; font-weight: 600; }
        .dual-axis-header .left { color: var(--dark-blue); }
        .dual-axis-header .right { color: var(--green); }
        .dual-axis-svg { width: 100%; height: 180px; min-height: 160px; }
        .lp { fill: none; stroke-width: 2; stroke-linecap: round; stroke-linejoin: round; }
        .la { opacity: 0.1; }
        .ld { r: 3.5; }
        .lc-x { display: flex; justify-content: space-between; font-size: 0.62rem; color: var(--text-muted); margin-top: 4px; }
        .legend { display: flex; gap: 16px; margin-top: 10px; font-size: 0.68rem; color: var(--text-muted); }
        .legend span { display: flex; align-items: center; gap: 4px; }
        .legend .sw { width: 10px; height: 10px; border-radius: 2px; }

        .table-panel { background: var(--white); border-radius: 10px; box-shadow: 0 2px 8px rgba(59,74,106,0.08); overflow: hidden; margin-bottom: 28px; }
        .table-panel .chart-title { padding: 18px 24px 0; }
        .rev-table { width: 100%; border-collapse: collapse; font-size: 0.78rem; }
        .rev-table th, .rev-table td { padding: 10px 14px; text-align: right; border-bottom: 1px solid var(--border); }
        .rev-table th { background: #F8FAFC; color: var(--text-muted); font-weight: 600; font-size: 0.7rem; }
        .rev-table th:first-child, .rev-table td:first-child { text-align: left; }
        .rev-table tr:hover { background: rgba(255,241,238,0.4); }
        .rev-table td:first-child { font-weight: 600; }
        .up { color: var(--green); }
        .down { color: var(--red); }

        @media (max-width: 900px) { .kpi-grid { grid-template-columns: repeat(3, 1fr); } .charts-row { grid-template-columns: 1fr; } }
    </style>
</head>
<body>
    <div class="top-bar">
        <div class="left">
            <div class="logo">CHUAN</div>
            <nav>
                <a href="{{ app_root }}/dashboard">概览</a>
                <a href="{{ app_root }}/partner/manage">资产商管理</a>
                <a href="{{ app_root }}/help">Help</a>
                <a class="active">{{ partner.name }}</a>
            </nav>
        </div>
        <div class="user-info">
            <span>{{ user.display_name }}</span>
            <span class="role-badge">{{ user.role_label }}</span>
            <a href="{{ app_root }}/logout" class="btn-link">退出</a>
        </div>
    </div>

    <div class="page">
        <div class="page-header">
            <div>
                <div class="left-group">
                    <a href="{{ app_root }}/partner/manage" class="btn-back">
                        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor"><path d="M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20v-2z"/></svg>
                        返回列表
                    </a>
                    <h1>{{ partner.name }} · 收益规模</h1>
                </div>
                <div class="sub" style="margin-left:100px;">{{ partner.country }} · {{ partner.product_type }} · 联系人：{{ partner.contact }}</div>
                <div class="no-pdf" style="margin-top:10px;display:flex;gap:16px;font-size:0.8rem;">
                    <a href="{{ app_root }}/partner/{{ partner.id }}/risk" style="color:var(--text-muted);text-decoration:none;">风控监控</a>
                    <span style="color:var(--green);font-weight:600;">收益规模</span>
                    <a href="{{ app_root }}/partner/{{ partner.id }}/cashflow" style="color:var(--text-muted);text-decoration:none;">现金流</a>
                </div>
            </div>
            <div class="header-right">
                {% if use_revenue_cache %}
                <div class="cache-status">
                    {% if cache_last_updated %}
                    <span class="cache-time" title="数据缓存时间">缓存于 {{ cache_last_updated or '-' }}</span>
                    {% else %}
                    <span class="cache-empty">暂无缓存，请点击刷新加载</span>
                    {% endif %}
                </div>
                <button class="btn-refresh" onclick="refreshRevenue()" title="从数据库重新拉取并缓存">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M17.65 6.35C16.2 4.9 14.21 4 12 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08c-.82 2.33-3.04 4-5.65 4-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>
                    刷新
                </button>
                {% endif %}
                <button class="btn-pdf" onclick="downloadPDF()" title="下载当前页面为 PDF">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/></svg>
                    下载 PDF
                </button>
                {% if local_currency != 'USD' %}
                <div class="currency-selector">
                    <div class="currency-selector-row">
                        <label>币种</label>
                        <div class="currency-toggle currency-toggle-header">
                            <button class="active" onclick="switchHeaderCurrency('usd',this)">USD</button>
                            <button onclick="switchHeaderCurrency('local',this)">{{ local_currency }}</button>
                        </div>
                    </div>
                    <span class="exchange-rate-hint">1 USD = {% if exchange_rate >= 1000 %}{{ "{:,.0f}".format(exchange_rate) }}{% else %}{{ "{:.2f}".format(exchange_rate) }}{% endif %} {{ local_currency }}</span>
                </div>
                {% endif %}
            </div>
        </div>

        <div id="content"></div>
    </div>

    <script>
        const partnerId = '{{ partner.id }}';
        const data = {{ revenue_data | tojson }};
        const localCurrency = '{{ local_currency }}';
        const exchangeRate = {{ exchange_rate }};

        async function refreshRevenue() {
            const btn = document.querySelector('.btn-refresh');
            if (btn) { btn.disabled = true; btn.classList.add('loading'); }
            try {
                const res = await fetch((window.APP_ROOT || '') + '/api/partner/' + partnerId + '/refresh-revenue', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({})
                });
                const result = await res.json();
                if (result.ok) {
                    location.reload();
                } else {
                    alert('刷新失败: ' + (result.error || '未知错误'));
                }
            } catch (e) {
                alert('刷新失败: ' + e.message);
            } finally {
                if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
            }
        }

        async function downloadPDF() {
            const btn = document.querySelector('.btn-pdf');
            if (btn) { btn.disabled = true; btn.classList.add('loading'); }
            try {
                document.body.classList.add('pdf-export');
                const el = document.querySelector('.page');
                const name = ({{ partner.name|tojson }} || 'report').replace(/[\/\\:*?"<>|]/g, '_');
                const opt = {
                    margin: [12, 12, 12, 12],
                    filename: name + '_收益规模.pdf',
                    image: { type: 'jpeg', quality: 0.95 },
                    html2canvas: { scale: 2, useCORS: true, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' },
                    pagebreak: { mode: ['avoid-all', 'css'], avoid: ['tr', '.kpi-card', '.chart-panel', '.table-panel'] }
                };
                await html2pdf().set(opt).from(el).save();
            } catch (e) {
                alert('下载失败: ' + (e.message || '未知错误'));
            } finally {
                document.body.classList.remove('pdf-export');
                if (btn) { btn.disabled = false; btn.classList.remove('loading'); }
            }
        }

        function _num(x) {
            if (x === null || x === undefined || x === '') return null;
            const n = parseFloat(x);
            return isNaN(n) ? null : n;
        }
        function fmtFormat(n) {
            const x = _num(n);
            if (x === null) return '-';
            if (x >= 1e6) return (x / 1e6).toFixed(1) + 'M';
            if (x >= 1e3) return (x / 1e3).toFixed(0) + 'K';
            return x.toLocaleString(undefined, {maximumFractionDigits: 0});
        }
        function getUsdVal(n) {
            const local = _num(n);
            return local != null && exchangeRate > 0 ? local / exchangeRate : local;
        }
        function fmtDisplayUSD(n) { const v = fmtFormat(n); return v === '-' ? v : '$' + v; }
        function fmtDisplayLocal(n) { return fmtFormat(n); }
        function fmtAmount(n) {
            return (window.currencyMode || 'usd') === 'usd' ? fmtDisplayUSD(getUsdVal(n)) : fmtDisplayLocal(n);
        }
        function fmtK(n) {
            return (window.currencyMode || 'usd') === 'usd' ? fmtDisplayUSD(getUsdVal(n)) : fmtDisplayLocal(n);
        }

        function render() {
            if (!data || data.length === 0) { document.getElementById('content').innerHTML = '<p style="padding:40px;text-align:center;color:var(--text-muted)">暂无收益数据</p>'; return; }

            const latest = data[data.length - 1];
            const prev = data.length > 1 ? data[data.length - 2] : latest;
            const totalRev = data.reduce((s, r) => s + r.net_revenue, 0);
            const totalInt = data.reduce((s, r) => s + r.interest_income, 0);
            const totalFee = data.reduce((s, r) => s + r.fee_income, 0);

            const balD = latest.outstanding_balance - prev.outstanding_balance;
            const revD = latest.net_revenue - prev.net_revenue;
            const maxDisb = Math.max(...data.map(r => r.disbursement));
            const maxColl = Math.max(...data.map(r => r.collection));
            const maxBarVal = Math.max(maxDisb, maxColl, 1);
            const beginBal = data.length > 1 ? prev.outstanding_balance : 0;
            const endBal = latest.outstanding_balance;
            const avgBal = (beginBal + endBal) / 2 || endBal;
            const yieldInterest = latest.interest_income;

            const svgW = 500, svgH = 120, pad = 8;
            const xStep = data.length > 1 ? (svgW - pad * 2) / (data.length - 1) : 0;
            const mkPts = (arr, maxV) => {
                const m = Math.max(maxV, 1e-9);
                return arr.map((v, i) => [pad + i * xStep, svgH - pad - Math.min(1, v / m) * (svgH - pad * 2)]);
            };
            const maxBal = Math.max(...data.map(r => r.outstanding_balance), 1);
            const maxYld = Math.max(...data.map(r => r.avg_yield_annualized), 0.01);
            const balPts = mkPts(data.map(r => r.outstanding_balance), maxBal);
            const yldPts = mkPts(data.map(r => r.avg_yield_annualized), maxYld * 1.1);
            const maxRev = Math.max(...data.map(r => r.net_revenue), 1);
            const revPts = mkPts(data.map(r => r.net_revenue), maxRev);

            const pl = pts => pts.map(([x, y]) => `${x.toFixed(1)},${y.toFixed(1)}`).join(' ');
            const ap = pts => { let p = `M ${pts[0][0].toFixed(1)},${svgH - pad}`; pts.forEach(([x, y]) => p += ` L ${x.toFixed(1)},${y.toFixed(1)}`); return p + ` L ${pts[pts.length-1][0].toFixed(1)},${svgH - pad} Z`; };

            document.getElementById('content').innerHTML = `
                <div class="section-title">收益概览 · 截至 ${latest.month}</div>
                <div class="kpi-grid">
                    <div class="kpi-card"><div class="kpi-label">在贷余额</div><div class="kpi-value">${fmtK(latest.outstanding_balance)}</div><div class="kpi-sub ${balD >= 0 ? 'up' : 'down'}">${balD >= 0 ? '↑' : '↓'} ${fmtK(Math.abs(balD))} vs 上月</div></div>
                    <div class="kpi-card"><div class="kpi-label">累计放款</div><div class="kpi-value">${fmtK(latest.cumulative_disbursement)}</div><div class="kpi-sub">运营 ${data.length} 个月</div></div>
                    <div class="kpi-card green"><div class="kpi-label">累计净收益</div><div class="kpi-value" style="color:var(--green)">${fmtK(totalRev)}</div><div class="kpi-sub">利息 ${fmtK(totalInt)} + 手续费 ${fmtK(totalFee)}</div></div>
                    <div class="kpi-card green yield-card">
                        <div class="kpi-label-with-help">
                            <span>年化收益率</span>
                            <span class="help-icon" title="点击查看计算公式" onclick="this.nextElementSibling.classList.toggle('show'); event.stopPropagation();">?</span>
                            <div class="yield-breakdown" onclick="event.stopPropagation();">
                                <div class="yield-breakdown-title">年化收益率计算公式</div>
                                <div class="yield-breakdown-formula">年化收益率 = 单月利息 ÷ ((期初余额 + 期末余额) ÷ 2) × 12</div>
                                <table class="yield-breakdown-table">
                                    <tr><td>期初余额（上月月末）</td><td>${fmtK(beginBal)}</td></tr>
                                    <tr><td>期末余额（当月月末）</td><td>${fmtK(endBal)}</td></tr>
                                    <tr><td>月均余额</td><td>${fmtK(avgBal)}</td></tr>
                                    <tr><td>单月利息（${latest.month}）</td><td>${fmtK(yieldInterest)}</td></tr>
                                    <tr><td>年化收益率</td><td style="color:var(--green)">${(latest.avg_yield_annualized * 100).toFixed(1)}%</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="kpi-value" style="color:var(--green)">${(latest.avg_yield_annualized * 100).toFixed(1)}%</div>
                        <div class="kpi-sub">目标 ≥ 15%</div>
                    </div>
                    <div class="kpi-card gold collection-card">
                        <div class="kpi-label-with-help">
                            <span>回收率</span>
                            <span class="help-icon" title="点击查看计算公式" onclick="this.nextElementSibling.classList.toggle('show'); event.stopPropagation();">?</span>
                            <div class="collection-breakdown" onclick="event.stopPropagation();">
                                <div class="yield-breakdown-title">回收率计算公式</div>
                                <div class="yield-breakdown-formula">回收率 = 实际回收 ÷ 应回收</div>
                                <table class="yield-breakdown-table">
                                    <tr><td>实际回收（${latest.month}）</td><td>${fmtK(latest.collection)}</td></tr>
                                    <tr><td>应回收（${latest.month}）</td><td>${fmtK(latest.collection_rate > 0 ? Math.round(latest.collection / latest.collection_rate) : 0)}</td></tr>
                                    <tr><td>回收率</td><td style="color:var(--gold)">${(latest.collection_rate * 100).toFixed(1)}%</td></tr>
                                </table>
                            </div>
                        </div>
                        <div class="kpi-value" style="color:var(--gold)">${(latest.collection_rate * 100).toFixed(1)}%</div>
                        <div class="kpi-sub">当月回收 ${fmtK(latest.collection)}</div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-panel">
                        <div class="chart-title">月度放款 vs 回收</div>
                        <div class="bar-chart">
                            ${data.map(r => {
                                const barMaxH = 120;
                                const hD = Math.max(4, (r.disbursement / maxBarVal) * barMaxH);
                                const hC = Math.max(4, (r.collection / maxBarVal) * barMaxH);
                                return `<div class="bar-group" title="${r.month}: 放款 ${fmtK(r.disbursement)}, 回收 ${fmtK(r.collection)}"><div class="bar-pair"><div><div class="bar-seg disb" style="height:${hD}px"></div></div><div><div class="bar-seg coll" style="height:${hC}px"></div></div></div><div class="bar-month">${r.month.slice(5)}</div><div class="bar-values"><span class="disb">${fmtK(r.disbursement)}</span><span class="coll">${fmtK(r.collection)}</span></div></div>`;
                            }).join('')}
                        </div>
                        <div class="legend"><span><div class="sw" style="background:var(--dark-blue)"></div>放款</span><span><div class="sw" style="background:var(--teal)"></div>回收</span></div>
                    </div>
                    <div class="chart-panel">
                        <div class="chart-title">在贷余额 & 年化收益率</div>
                        <div class="dual-axis-chart">
                            ${(() => {
                                const pad = 24, chartW = 460, chartH = 120, topPad = 12, n = data.length;
                                const slotW = n > 0 ? chartW / n : 0;
                                const barW = Math.min(slotW * 0.5, 36);
                                const vbW = pad * 2 + chartW;
                                const vbH = topPad + chartH + 36;
                                const balArr = data.map(r => r.outstanding_balance);
                                const yldArr = data.map(r => r.avg_yield_annualized);
                                const maxB = Math.max(...balArr, 1);
                                const maxY = Math.max(...yldArr, 0.01);
                                let bars = '', linePts = [], circles = '', monthLabels = '', barLabels = '', lineLabels = '';
                                for (let i = 0; i < n; i++) {
                                    const cx = pad + (i + 0.5) * slotW;
                                    const barH = maxB > 0 ? Math.max(2, (balArr[i] / maxB) * chartH) : 0;
                                    const barX = cx - barW / 2;
                                    const barY = topPad + chartH - barH;
                                    bars += '<rect x="'+barX+'" y="'+barY+'" width="'+barW+'" height="'+barH+'" fill="var(--dark-blue)" opacity="0.85" rx="2"/>';
                                    barLabels += '<text x="'+cx+'" y="'+(topPad+chartH+14)+'" font-size="9" fill="var(--dark-blue)" text-anchor="middle">'+fmtK(balArr[i])+'</text>';
                                    const lineY = topPad + chartH - (maxY > 0 ? Math.min(1, yldArr[i] / maxY) * chartH : 0);
                                    linePts.push(cx+','+lineY);
                                    circles += '<circle cx="'+cx+'" cy="'+lineY+'" r="4" fill="var(--white)" stroke="var(--gold)" stroke-width="2"/>';
                                    const lblY = lineY < topPad + chartH / 2 ? lineY + 12 : lineY - 8;
                                    lineLabels += '<text x="'+cx+'" y="'+lblY+'" font-size="9" fill="var(--gold)" text-anchor="middle">'+((yldArr[i]*100).toFixed(1))+'%</text>';
                                    monthLabels += '<text x="'+cx+'" y="'+(vbH-6)+'" font-size="10" fill="var(--text-muted)" text-anchor="middle">'+data[i].month.slice(5)+'</text>';
                                }
                                return '<svg class="dual-axis-svg" viewBox="0 0 '+vbW+' '+vbH+'" preserveAspectRatio="xMidYMid meet">'+
                                    bars+barLabels+
                                    '<polyline points="'+linePts.join(' ')+'" fill="none" stroke="var(--gold)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" stroke-dasharray="6,4"/>'+
                                    circles+lineLabels+
                                    monthLabels+
                                '</svg>';
                            })()}
                        </div>
                        <div class="legend" style="margin-top:10px"><span><div class="sw" style="background:var(--dark-blue)"></div>在贷余额</span><span><div class="sw" style="background:var(--gold);border-radius:50%"></div>年化收益率</span></div>
                    </div>
                </div>

                <div class="charts-row">
                    <div class="chart-panel">
                        <div class="chart-title">月度净收益</div>
                        <div class="stacked-bar-chart">
                            ${(() => {
                                const maxNet = Math.max(...data.map(r => r.net_revenue), 1);
                                const barMaxH = 120;
                                return data.map(r => {
                                    const hInt = Math.max(2, (r.interest_income / maxNet) * barMaxH);
                                    const hFee = Math.max(2, (r.fee_income / maxNet) * barMaxH);
                                    return '<div class="stacked-bar-group" title="'+r.month+': 利息 '+fmtK(r.interest_income)+', 手续费 '+fmtK(r.fee_income)+'">'+
                                        '<div class="stacked-bar-wrap">'+
                                            '<div class="stacked-bar-seg interest" style="height:'+hInt+'px" title="利息 '+fmtK(r.interest_income)+'"></div>'+
                                            '<div class="stacked-bar-seg fee" style="height:'+hFee+'px" title="手续费 '+fmtK(r.fee_income)+'"></div>'+
                                        '</div>'+
                                        '<div class="stacked-bar-month">'+r.month.slice(5)+'</div>'+
                                        '<div class="stacked-bar-values"><span class="interest">'+fmtK(r.interest_income)+'</span> + <span class="fee">'+fmtK(r.fee_income)+'</span></div>'+
                                    '</div>';
                                }).join('');
                            })()}
                        </div>
                        <div class="legend"><span><div class="sw" style="background:var(--green)"></div>利息</span><span><div class="sw" style="background:var(--teal)"></div>手续费</span></div>
                    </div>
                    <div class="chart-panel">
                        <div class="chart-title">回收率走势</div>
                        <div class="line-wrap cr-chart-wrap">
                            <svg viewBox="0 0 520 140" preserveAspectRatio="xMidYMid meet">
                                ${(() => {
                                    const pad = 24, chartW = 520 - pad * 2, chartH = 100, topPad = 16, bottomPad = 8;
                                    const n = data.length;
                                    const xStep = n > 1 ? chartW / (n - 1) : 0;
                                    const crData = data.map(r => r.collection_rate);
                                    const crMin = Math.min(...crData);
                                    const crMax = Math.max(...crData);
                                    const range = Math.max(crMax - crMin, 0.05);
                                    const rangeMin = Math.max(0, crMin - range * 0.1);
                                    const rangeMax = Math.min(1, crMax + range * 0.1);
                                    const scaleRange = rangeMax - rangeMin || 0.05;
                                    const crPts = crData.map((v, i) => [
                                        pad + i * xStep,
                                        topPad + chartH * (1 - (v - rangeMin) / scaleRange)
                                    ]);
                                    const crVals = data.map(r => (r.collection_rate * 100).toFixed(1) + '%');
                                    const plCr = pts => pts.map(([x, y]) => `${x.toFixed(1)},${y.toFixed(1)}`).join(' ');
                                    const polyline = `<polyline class="lp" points="${plCr(crPts)}" stroke="var(--gold)"/>`;
                                    const pointsAndLabels = crPts.map(([x, y], i) => {
                                        const labelY = y < topPad + chartH / 2 ? y + 10 : y - 6;
                                        return `<circle class="ld" cx="${x.toFixed(1)}" cy="${y.toFixed(1)}" fill="var(--gold)"/>` +
                                            `<text class="line-value-label" x="${x.toFixed(1)}" y="${labelY.toFixed(1)}">${crVals[i]}</text>`;
                                    }).join('');
                                    return polyline + pointsAndLabels;
                                })()}
                            </svg>
                        </div>
                        <div class="lc-x" style="padding:0 24px">${data.map(r => `<span>${r.month.slice(5)}</span>`).join('')}</div>
                        <div class="legend"><span><div class="sw" style="background:var(--gold)"></div>回收率</span></div>
                    </div>
                </div>

                <div class="table-panel">
                    <div class="chart-title">月度明细</div>
                    <table class="rev-table">
                        <thead><tr><th>月份</th><th>放款金额</th><th>在贷余额</th><th>回收金额</th><th>利息收入</th><th>手续费</th><th>净收益</th><th>年化收益</th><th>回收率</th></tr></thead>
                        <tbody>
                            ${[...data].reverse().map((r, i, arr) => {
                                const p = i < arr.length - 1 ? arr[i + 1] : null;
                                const rt = p ? (r.net_revenue >= p.net_revenue ? 'up' : 'down') : '';
                                return `<tr><td>${r.month}</td><td>${fmtK(r.disbursement)}</td><td>${fmtK(r.outstanding_balance)}</td><td>${fmtK(r.collection)}</td><td>${fmtK(r.interest_income)}</td><td>${fmtK(r.fee_income)}</td><td class="${rt}">${fmtK(r.net_revenue)}</td><td>${(r.avg_yield_annualized * 100).toFixed(1)}%</td><td>${(r.collection_rate * 100).toFixed(1)}%</td></tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }
        function switchHeaderCurrency(mode, btn) {
            window.currencyMode = mode;
            const toggle = btn ? btn.parentElement : document.querySelector('.currency-toggle-header');
            if (toggle) {
                toggle.querySelectorAll('button').forEach(b => b.classList.remove('active'));
                if (btn) btn.classList.add('active');
            }
            render();
        }

        render();
        document.addEventListener('click', function() {
            document.querySelectorAll('.yield-breakdown.show, .collection-breakdown.show').forEach(el => el.classList.remove('show'));
        });
    </script>
    {% include '_data_source_status.html' %}
</body>
</html>
