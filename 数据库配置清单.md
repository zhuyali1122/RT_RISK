# RT_RISK 数据库配置清单

根据 [阿里云 RDS PostgreSQL 官方文档](https://help.aliyun.com/zh/rds/apsaradb-rds-for-postgresql/connect-to-an-apsaradb-rds-for-postgresql-instance)，连接前需完成以下配置。

---

## 一、前提条件（RDS 控制台）

| 步骤 | 说明 |
|------|------|
| 1. 创建实例 | 已创建 RDS PostgreSQL 实例 |
| 2. 创建账号和数据库 | 在 RDS 控制台 → 账号管理、数据库管理 |
| 3. **设置白名单** | 将客户端 IP 加入白名单，否则无法连接 |

---

## 二、公网连接必须完成的设置

### 1. 申请外网地址

- 公网地址需**手动申请**，默认不开放
- RDS 控制台 → 实例详情 → **数据库连接** → 申请外网地址
- 参考：[申请外网地址](https://help.aliyun.com/zh/rds/apsaradb-rds-for-postgresql/apply-for-or-release-a-public-endpoint-on-an-apsaradb-rds-for-postgresql-instance)

### 2. 设置白名单

- RDS 控制台 → 实例详情 → **白名单与安全组**
- 将**客户端公网 IP** 加入白名单
- 查询本机公网 IP：`curl ipinfo.io/ip` 或 `curl https://api.ipify.org`
- 多个 IP 用英文逗号分隔

### 3. 高安全白名单模式

- 若已开启**高安全白名单模式**，公网连接需添加到 **经典网络** 分组
- 否则即使 IP 正确也可能无法连接

---

## 三、连接信息获取位置

| 配置项 | 获取位置 |
|--------|----------|
| 连接地址 | RDS 控制台 → 数据库连接 → 外网地址（公网）或内网地址 |
| 端口 | 默认 5432，可在数据库连接页面查看或修改（范围 1000–5999） |
| 用户名/密码 | 账号管理页面 |
| 数据库名 | 数据库管理页面（勿使用 postgres 系统库做业务） |

---

## 四、SSL 配置

| RDS SSL 状态 | 客户端 sslmode |
|--------------|----------------|
| 已开启 SSL | `require`、`verify-ca` 或 `verify-full` |
| 未开启 SSL | `disable` |
| 配置了客户端 CA 证书 | 必须使用 `require`、`verify-ca` 或 `verify-full` |

- `require`：仅加密链路，不校验服务端证书（常用）
- `verify-ca` / `verify-full`：需配置 CA 证书文件

---

## 五、.env 配置

### 方式一：DATABASE_URL（推荐）

```env
DATABASE_URL=postgresql+asyncpg://user:password@外网地址:5432/数据库名?sslmode=require
DATABASE_POOL_SIZE=20
DATABASE_MAX_OVERFLOW=10
```

- 外网地址从 RDS 控制台「数据库连接」获取
- 若 RDS 已开启 SSL，使用 `?sslmode=require`；未开启则用 `?sslmode=disable`
- 可通过 `DB_SSLMODE` 覆盖：`DB_SSLMODE=require` 或 `DB_SSLMODE=disable`

### 方式二：独立变量

```env
DB_HOST=pgm-xxxxx.pg.rds.aliyuncs.com
DB_PORT=5432
DB_NAME=your_database
DB_USER=your_username
DB_PASSWORD=your_password
```

---

## 六、连接超时排查（Connection timed out）

根据官方文档，常见原因与处理：

| 检查项 | 操作 |
|--------|------|
| **白名单** | 确认本机公网 IP 已加入，用 `curl ipinfo.io/ip` 核对 |
| **公网地址** | 确认已申请外网地址且未释放 |
| **高安全白名单** | 若开启，公网 IP 需加入**经典网络**分组 |
| **连接地址** | 本机访问必须用**外网地址**，不能用内网地址 |

---

## 七、测试与启动

```bash
cd RT_RISK
pip install -r requirements.txt
cp .env.example .env
# 编辑 .env 填入配置
python db_connect.py   # 测试连接
python app.py         # 启动 Web 应用
```

浏览器访问：**http://localhost:5000**
